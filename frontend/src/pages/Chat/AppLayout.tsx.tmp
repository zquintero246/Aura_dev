// AppLayout.tsx
import React, { useEffect, useMemo, useState } from 'react';
import IconRail from './IconRail';
import ConversationsPanel, { Conversation } from './ConversationsPanel';
import GroupsPanel, { Group } from './GroupsPanel';
import MainPanel from './MainPanel';
import ProfilePanel from '../Account/Profile';
import ChatPanel from './ChatPanel';
import { me, logout, User } from '../../lib/auth';
import { useNavigate } from 'react-router-dom';
import { listConversations, createConversation_removed } from '../../lib/conversations';

type SectionKey = 'chats' | 'group' | 'project' | 'telemetry';

type Selection =
  | { type: 'chat'; id: string }
  | { type: 'group'; id: string }
  | { type: 'project'; id: string }
  | { type: 'telemetry'; view: 'overview' | 'errors' | 'latency' }
  | { type: 'profile' }
  | null;

const RAIL_W = 72;
const SIDE_W = 320;

export default function AppLayout() {
  const navigate = useNavigate();
  const [activeRail, setActiveRail] = useState<SectionKey>('chats');
  const [conversationsOpen, setConversationsOpen] = useState(true);
  const [selection, setSelection] = useState<Selection>(null);

  // Sin conversaciones por defecto; se cargan desde backend
  const [pinned, setPinned] = useState<Conversation[]>([]);
  const [recent, setRecent] = useState<Conversation[]>([]);

  // Grupos (demo)
  const [myGroups] = useState<Group[]>([
    { id: 'g1', name: 'Equipo Backend', members: 12, unread: 3 },
    { id: 'g2', name: 'Diseño UX', members: 7 },
  ]);
  const [explore] = useState<Group[]>([
    { id: 'g3', name: 'IA & LLMs', members: 56 },
    { id: 'g4', name: 'DevOps Lovers', members: 31, unread: 1 },
  ]);

  const mainPaddingLeft = useMemo(() => {
    const side =
      activeRail === 'chats'
        ? conversationsOpen
          ? SIDE_W
          : 0
        : activeRail === 'group'
        ? SIDE_W
        : 0;
    return `${RAIL_W + side}px`;
  }, [activeRail, conversationsOpen]);

  // Crear conversación (persistente)
  const handleCreateChat = async () => {
    const tempId = `tmp-${crypto.randomUUID()}`;
    const tempConv: Conversation = { id: tempId, title: 'Nueva conversación' };
    setRecent((r) => [tempConv, ...r]);
    setSelection({ type: 'chat', id: tempId });
    try {
      const conv = await createConversation_removed('Nueva conversación');
      setRecent((r) => [conv, ...r.filter((c) => c.id !== tempId)]);
      setSelection({ type: 'chat', id: conv.id });
    } catch {
      // dejamos la temporal; usuario puede reintentar
    }
  };

  const handleSearchChat = (q: string) => {
    console.log('buscar chat:', q);
  };

  const handleChatTitleChange = (id: string, newTitle: string) => {
    setPinned((prev) => prev.map((c) => (c.id === id ? { ...c, title: newTitle } : c)));
    setRecent((prev) => prev.map((c) => (c.id === id ? { ...c, title: newTitle } : c)));
  };

  // Pin/unpin con límite 3
  const handleTogglePin = (id: string, nextPinned: boolean) => {
    if (nextPinned) {
      if (pinned.length >= 3) {
        try { window.alert('Solo puedes anclar hasta 3 conversaciones'); } catch {}
        return;
      }
      const item = recent.find((c) => c.id === id);
      if (item && !pinned.find((p) => p.id === id)) {
        setRecent((r) => r.filter((c) => c.id !== id));
        setPinned((p) => [...p, { ...item, pinned: true }]);
      }
    } else {
      const item = pinned.find((c) => c.id === id);
      if (item) {
        setPinned((p) => p.filter((c) => c.id !== id));
        setRecent((r) => [{ ...item, pinned: false }, ...r.filter((c) => c.id !== id)]);
      }
    }
  };

  const activeChat =
    (selection?.type === 'chat' &&
      (pinned.find((c) => c.id === selection.id) || recent.find((c) => c.id === selection.id))) ||
    null;

  // Sesión de usuario
  const [user, setUser] = useState<User | null>(null);
  useEffect(() => {
    (async () => {
      try {
        const res = await me();
        setUser(res?.user || null);
      } catch {
        setUser(null);
      }
    })();
  }, []);

  const handleLogout = async () => {
    try { await logout(); } catch {}
    navigate('/login');
  };

  // Cerrar panel de conversaciones con evento global
  useEffect(() => {
    const handler = () => setConversationsOpen(false);
    window.addEventListener('aura:conversations:close', handler as EventListener);
    return () => {
      window.removeEventListener('aura:conversations:close', handler as EventListener);
    };
  }, []);

  // Tema persistente
  useEffect(() => {
    const saved = localStorage.getItem('aura:theme');
    if (saved === 'light') document.documentElement.classList.add('theme-light');
  }, []);

  const handleToggleTheme = () => {
    const el = document.documentElement;
    el.classList.add('theme-xfade');
    const isLight = el.classList.toggle('theme-light');
    localStorage.setItem('aura:theme', isLight ? 'light' : 'dark');
    window.setTimeout(() => el.classList.remove('theme-xfade'), 260);
  };

  // Cargar conversaciones del backend al montar
  useEffect(() => {
    (async () => {
      try {
        const items = await listConversations();
        setRecent(items);
        if (!selection && items.length) setSelection({ type: 'chat', id: items[0].id });
      } catch {}
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <div className="min-h-screen bg-[#070a14] text-white">
      {/* IconRail */}
      <IconRail
        active={activeRail}
        onSelect={(key) => {
          setActiveRail(key);
          setConversationsOpen(true);
        }}
        onToggleTheme={handleToggleTheme}
        avatarUrl={user?.avatar_url || undefined}
        userName={user?.name || 'Tu perfil'}
        onProfile={() => {
          setSelection({ type: 'profile' });
          setConversationsOpen(false);
        }}
        onSettings={() => navigate('/settings')}
        onChangePassword={() => navigate('/change-password')}
        onLogout={handleLogout}
      />

      {/* Panel de conversaciones */}
      {activeRail === 'chats' && conversationsOpen && (
        <ConversationsPanel
          railWidth={RAIL_W}
          pinned={pinned}
          recent={recent}
          selectedId={selection?.type === 'chat' ? selection.id : undefined}
          onSelect={(id) => setSelection({ type: 'chat', id })}
          onCreate={handleCreateChat}
          onSearch={handleSearchChat}
          onTogglePin={handleTogglePin}
        />
      )}

      {/* Panel de grupos */}
      {activeRail === 'group' && (
        <GroupsPanel
          railWidth={RAIL_W}
          myGroups={myGroups}
          explore={explore}
          selectedId={selection?.type === 'group' ? selection.id : undefined}
          onSelect={(id) => setSelection({ type: 'group', id })}
          onCreate={() => console.log('crear grupo')}
          onSearch={(q) => console.log('buscar grupo:', q)}
        />
      )}

      {/* Panel principal */}
      <main style={{ paddingLeft: mainPaddingLeft }} className="pt-6 pr-6 pb-6 h-screen overflow-hidden">
        {selection?.type === 'profile' ? (
          <div className="w-full h-full">
            <ProfilePanel
              name={user?.name || ''}
              email={user?.email || ''}
              id={user?.id || ''}
              avatarUrl={user?.avatar_url || undefined}
            />
          </div>
        ) : activeChat ? (
          <ChatPanel
            conversationId={activeChat.id}
            onTitleChange={handleChatTitleChange}
            userName={user?.name || 'Tú'}
            userAvatar={user?.avatar_url || '/images/avatar_demo.jpg'}
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center">
            <MainPanel selection={selection} />
          </div>
        )}
      </main>
    </div>
  );
}
